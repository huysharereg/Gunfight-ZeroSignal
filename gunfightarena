-- Gunfight Arena Hack - Fresh Rebuild
-- No external dependencies, simple and working

-- ========== SETUP ==========
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")

-- Wait for everything to load
repeat task.wait() until game:IsLoaded()
local player = Players.LocalPlayer
repeat task.wait() until player

print("ðŸŽ® Gunfight Arena Hack Initializing...")

local camera = Workspace.CurrentCamera

-- ========== SETTINGS ==========
local Settings = {
    Aimbot = false,
    ESP = false,
    UnlimitedAmmo = false,
    FOV = 120,
    TeamCheck = true,
    VisibleCheck = true
}

-- ========== DRAWING OBJECTS ==========
local FOVCircle
local ESPCache = {}

-- ========== UTILITY FUNCTIONS ==========
local function createFOVCircle()
    if FOVCircle then
        FOVCircle:Remove()
    end
    
    FOVCircle = Drawing.new("Circle")
    FOVCircle.Visible = Settings.Aimbot
    FOVCircle.Radius = Settings.FOV
    FOVCircle.Thickness = 2
    FOVCircle.Color = Color3.fromRGB(255, 0, 0)
    FOVCircle.Filled = false
    FOVCircle.Position = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
end

-- Check if player is enemy
local function isEnemy(targetPlayer)
    if targetPlayer == player then return false end
    if not Settings.TeamCheck then return true end
    
    -- Try different ways to get team
    local myTeam = player.Team
    local targetTeam = targetPlayer.Team
    
    -- If no Team objects, check attributes
    if not myTeam or not targetTeam then
        myTeam = player:GetAttribute("Team")
        targetTeam = targetPlayer:GetAttribute("Team")
    end
    
    -- If still no teams, assume all are enemies
    if not myTeam or not targetTeam then
        return true
    end
    
    -- Compare teams
    local myTeamName = typeof(myTeam) == "Instance" and myTeam.Name or tostring(myTeam)
    local targetTeamName = typeof(targetTeam) == "Instance" and targetTeam.Name or tostring(targetTeam)
    
    return myTeamName ~= targetTeamName
end

-- Check if player is visible
local function isVisible(targetPart)
    if not Settings.VisibleCheck then return true end
    
    local origin = camera.CFrame.Position
    local direction = (targetPart.Position - origin).Unit * 1000
    
    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {player.Character, targetPart.Parent}
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    
    local result = Workspace:Raycast(origin, direction, raycastParams)
    
    if result then
        -- Check if what we hit is part of the target
        return result.Instance:IsDescendantOf(targetPart.Parent)
    end
    
    return true
end

-- ========== AIMBOT ==========
local function findBestTarget()
    local bestTarget = nil
    local closestDistance = Settings.FOV
    local screenCenter = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
    
    for _, targetPlayer in pairs(Players:GetPlayers()) do
        if targetPlayer == player then continue end
        if not isEnemy(targetPlayer) then continue end
        
        local character = targetPlayer.Character
        if not character then continue end
        
        local humanoid = character:FindFirstChild("Humanoid")
        if not humanoid or humanoid.Health <= 0 then continue end
        
        local head = character:FindFirstChild("Head")
        if not head then continue end
        
        -- Check visibility
        if not isVisible(head) then continue end
        
        -- Get screen position
        local screenPos, onScreen = camera:WorldToViewportPoint(head.Position)
        if not onScreen then continue end
        
        -- Calculate distance from crosshair
        local distance = (Vector2.new(screenPos.X, screenPos.Y) - screenCenter).Magnitude
        
        if distance < closestDistance then
            closestDistance = distance
            bestTarget = targetPlayer
        end
    end
    
    return bestTarget
end

local function aimAtTarget()
    if not Settings.Aimbot then return end
    
    local target = findBestTarget()
    if not target or not target.Character then return end
    
    local head = target.Character:FindFirstChild("Head")
    if not head then return end
    
    local screenPos = camera:WorldToScreenPoint(head.Position)
    if screenPos.Z <= 0 then return end
    
    local screenCenter = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
    local targetPos = Vector2.new(screenPos.X, screenPos.Y)
    local delta = (targetPos - screenCenter) * 0.2  -- Smoothing
    
    mousemoverel(delta.X, delta.Y)
end

-- ========== ESP ==========
local function updateESP()
    for _, targetPlayer in pairs(Players:GetPlayers()) do
        if targetPlayer == player then continue end
        
        local character = targetPlayer.Character
        local humanoid = character and character:FindFirstChild("Humanoid")
        
        if Settings.ESP and character and humanoid and humanoid.Health > 0 then
            -- Only show ESP for enemies
            if not isEnemy(targetPlayer) then
                if ESPCache[targetPlayer] then
                    ESPCache[targetPlayer].Box.Visible = false
                    ESPCache[targetPlayer].Name.Visible = false
                    ESPCache[targetPlayer].HealthBar.Visible = false
                end
                continue
            end
            
            local root = character:FindFirstChild("HumanoidRootPart")
            local head = character:FindFirstChild("Head")
            
            if root and head then
                local rootPos, onScreen = camera:WorldToViewportPoint(root.Position)
                
                if onScreen then
                    -- Create ESP drawings if they don't exist
                    if not ESPCache[targetPlayer] then
                        ESPCache[targetPlayer] = {
                            Box = Drawing.new("Square"),
                            Name = Drawing.new("Text"),
                            HealthBar = Drawing.new("Square")
                        }
                        
                        local esp = ESPCache[targetPlayer]
                        
                        -- Box setup
                        esp.Box.Thickness = 2
                        esp.Box.Color = Color3.fromRGB(255, 50, 50)
                        esp.Box.Filled = false
                        
                        -- Name setup
                        esp.Name.Color = Color3.fromRGB(255, 255, 255)
                        esp.Name.Size = 14
                        esp.Name.Font = 2
                        esp.Name.Outline = true
                        
                        -- Health bar setup
                        esp.HealthBar.Color = Color3.fromRGB(0, 255, 0)
                        esp.HealthBar.Filled = true
                    end
                    
                    local esp = ESPCache[targetPlayer]
                    local headPos = camera:WorldToViewportPoint(head.Position)
                    
                    -- Calculate box size
                    local height = math.abs(headPos.Y - rootPos.Y) * 2
                    local width = height * 0.6
                    
                    -- Update box
                    esp.Box.Size = Vector2.new(width, height)
                    esp.Box.Position = Vector2.new(rootPos.X - width/2, rootPos.Y - height/2)
                    esp.Box.Visible = true
                    
                    -- Update name
                    esp.Name.Text = targetPlayer.Name
                    esp.Name.Position = Vector2.new(rootPos.X, rootPos.Y - height/2 - 20)
                    esp.Name.Visible = true
                    
                    -- Update health bar
                    local healthPercent = humanoid.Health / humanoid.MaxHealth
                    local barWidth = 60
                    local barHeight = 4
                    
                    esp.HealthBar.Size = Vector2.new(barWidth * healthPercent, barHeight)
                    esp.HealthBar.Position = Vector2.new(rootPos.X - barWidth/2, rootPos.Y + height/2 + 5)
                    esp.HealthBar.Visible = true
                    
                    -- Change health bar color based on health
                    if healthPercent > 0.6 then
                        esp.HealthBar.Color = Color3.fromRGB(0, 255, 0)
                    elseif healthPercent > 0.3 then
                        esp.HealthBar.Color = Color3.fromRGB(255, 255, 0)
                    else
                        esp.HealthBar.Color = Color3.fromRGB(255, 0, 0)
                    end
                elseif ESPCache[targetPlayer] then
                    -- Hide ESP if not on screen
                    ESPCache[targetPlayer].Box.Visible = false
                    ESPCache[targetPlayer].Name.Visible = false
                    ESPCache[targetPlayer].HealthBar.Visible = false
                end
            end
        elseif ESPCache[targetPlayer] then
            -- Hide ESP if player is dead or doesn't exist
            ESPCache[targetPlayer].Box.Visible = false
            ESPCache[targetPlayer].Name.Visible = false
            ESPCache[targetPlayer].HealthBar.Visible = false
        end
    end
    
    -- Clean up cache for players who left
    for cachedPlayer, _ in pairs(ESPCache) do
        if not Players:FindFirstChild(cachedPlayer.Name) then
            ESPCache[cachedPlayer].Box:Remove()
            ESPCache[cachedPlayer].Name:Remove()
            ESPCache[cachedPlayer].HealthBar:Remove()
            ESPCache[cachedPlayer] = nil
        end
    end
end

-- ========== UNLIMITED AMMO ==========
local function updateAmmo()
    if not Settings.UnlimitedAmmo then return end
    
    local character = player.Character
    if not character then return end
    
    -- Check all tools/weapons
    for _, tool in pairs(character:GetChildren()) do
        if tool:IsA("Tool") then
            -- Look for ammo values
            local function updateValue(obj)
                if obj:IsA("NumberValue") then
                    -- Common ammo value names
                    local nameLower = obj.Name:lower()
                    if nameLower:find("ammo") or nameLower:find("bullet") or nameLower:find("clip") then
                        if obj.Value < 30 then  -- Only refill if low
                            obj.Value = 999
                        end
                    end
                end
            end
            
            -- Check tool directly
            updateValue(tool)
            
            -- Check all descendants
            for _, descendant in pairs(tool:GetDescendants()) do
                updateValue(descendant)
            end
        end
    end
end

-- ========== UI ==========
local function createUI()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "GunfightHackUI"
    ScreenGui.Parent = game:GetService("CoreGui")
    ScreenGui.ResetOnSpawn = false
    
    -- Main Frame
    local MainFrame = Instance.new("Frame")
    MainFrame.Size = UDim2.new(0, 280, 0, 250)
    MainFrame.Position = UDim2.new(0, 20, 0, 20)
    MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    MainFrame.BorderSizePixel = 0
    MainFrame.Parent = ScreenGui
    
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 8)
    UICorner.Parent = MainFrame
    
    -- Title Bar
    local TitleBar = Instance.new("Frame")
    TitleBar.Size = UDim2.new(1, 0, 0, 35)
    TitleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    TitleBar.BorderSizePixel = 0
    TitleBar.Parent = MainFrame
    
    local TitleCorner = Instance.new("UICorner")
    TitleCorner.CornerRadius = UDim.new(0, 8)
    TitleCorner.Parent = TitleBar
    
    -- Title
    local Title = Instance.new("TextLabel")
    Title.Size = UDim2.new(0.8, 0, 1, 0)
    Title.Position = UDim2.new(0, 10, 0, 0)
    Title.BackgroundTransparency = 1
    Title.Text = "ðŸ”« GUNFIGHT HACK"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 16
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.Parent = TitleBar
    
    -- Close Button
    local CloseButton = Instance.new("TextButton")
    CloseButton.Size = UDim2.new(0, 25, 0, 25)
    CloseButton.Position = UDim2.new(1, -30, 0.5, -12.5)
    CloseButton.AnchorPoint = Vector2.new(1, 0.5)
    CloseButton.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
    CloseButton.Text = "âœ•"
    CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseButton.Font = Enum.Font.GothamBold
    CloseButton.TextSize = 14
    CloseButton.Parent = TitleBar
    
    local CloseCorner = Instance.new("UICorner")
    CloseCorner.CornerRadius = UDim.new(0, 5)
    CloseCorner.Parent = CloseButton
    
    -- Content
    local Content = Instance.new("Frame")
    Content.Size = UDim2.new(1, -20, 1, -50)
    Content.Position = UDim2.new(0, 10, 0, 45)
    Content.BackgroundTransparency = 1
    Content.Parent = MainFrame
    
    -- Create Toggle Function
    local function createToggle(text, setting, yPos)
        local ToggleFrame = Instance.new("Frame")
        ToggleFrame.Size = UDim2.new(1, 0, 0, 40)
        ToggleFrame.Position = UDim2.new(0, 0, 0, yPos)
        ToggleFrame.BackgroundTransparency = 1
        ToggleFrame.Parent = Content
        
        local ToggleButton = Instance.new("TextButton")
        ToggleButton.Size = UDim2.new(1, 0, 1, 0)
        ToggleButton.BackgroundColor3 = Color3.fromRGB(40, 40, 55)
        ToggleButton.Text = ""
        ToggleButton.Parent = ToggleFrame
        
        local ToggleCorner = Instance.new("UICorner")
        ToggleCorner.CornerRadius = UDim.new(0, 6)
        ToggleCorner.Parent = ToggleButton
        
        local ToggleText = Instance.new("TextLabel")
        ToggleText.Size = UDim2.new(0.7, 0, 1, 0)
        ToggleText.Position = UDim2.new(0, 10, 0, 0)
        ToggleText.BackgroundTransparency = 1
        ToggleText.Text = "  " .. text
        ToggleText.TextColor3 = Color3.fromRGB(255, 255, 255)
        ToggleText.Font = Enum.Font.Gotham
        ToggleText.TextSize = 14
        ToggleText.TextXAlignment = Enum.TextXAlignment.Left
        ToggleText.Parent = ToggleButton
        
        local Indicator = Instance.new("Frame")
        Indicator.Size = UDim2.new(0, 40, 0, 20)
        Indicator.Position = UDim2.new(1, -45, 0.5, -10)
        Indicator.AnchorPoint = Vector2.new(1, 0.5)
        Indicator.BackgroundColor3 = Settings[setting] and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(80, 80, 80)
        Indicator.Parent = ToggleButton
        
        local IndicatorCorner = Instance.new("UICorner")
        IndicatorCorner.CornerRadius = UDim.new(0, 10)
        IndicatorCorner.Parent = Indicator
        
        ToggleButton.MouseButton1Click:Connect(function()
            Settings[setting] = not Settings[setting]
            Indicator.BackgroundColor3 = Settings[setting] and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(80, 80, 80)
            
            if setting == "Aimbot" then
                if FOVCircle then
                    FOVCircle.Visible = Settings.Aimbot
                else
                    createFOVCircle()
                end
            end
            
            print("[" .. text .. "] " .. (Settings[setting] and "ON" or "OFF"))
        end)
        
        return ToggleFrame
    end
    
    -- Create FOV Slider
    local function createFOVSlider(yPos)
        local SliderFrame = Instance.new("Frame")
        SliderFrame.Size = UDim2.new(1, 0, 0, 60)
        SliderFrame.Position = UDim2.new(0, 0, 0, yPos)
        SliderFrame.BackgroundTransparency = 1
        SliderFrame.Parent = Content
        
        local SliderText = Instance.new("TextLabel")
        SliderText.Size = UDim2.new(1, 0, 0, 20)
        SliderText.BackgroundTransparency = 1
        SliderText.Text = "FOV: " .. Settings.FOV
        SliderText.TextColor3 = Color3.fromRGB(255, 255, 255)
        SliderText.Font = Enum.Font.Gotham
        SliderText.TextSize = 14
        SliderText.TextXAlignment = Enum.TextXAlignment.Left
        SliderText.Parent = SliderFrame
        
        local SliderBar = Instance.new("Frame")
        SliderBar.Size = UDim2.new(1, 0, 0, 6)
        SliderBar.Position = UDim2.new(0, 0, 0, 30)
        SliderBar.BackgroundColor3 = Color3.fromRGB(60, 60, 75)
        SliderBar.Parent = SliderFrame
        
        local SliderFill = Instance.new("Frame")
        SliderFill.Size = UDim2.new(Settings.FOV / 500, 0, 1, 0)
        SliderFill.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        SliderFill.Parent = SliderBar
        
        local SliderButton = Instance.new("TextButton")
        SliderButton.Size = UDim2.new(0, 20, 0, 20)
        SliderButton.Position = UDim2.new(Settings.FOV / 500, -10, 0.5, -10)
        SliderButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        SliderButton.Text = ""
        SliderButton.Parent = SliderBar
        
        SliderButton.MouseButton1Down:Connect(function()
            local connection
            connection = UserInputService.InputChanged:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseMovement then
                    local percent = math.clamp(
                        (input.Position.X - SliderBar.AbsolutePosition.X) / SliderBar.AbsoluteSize.X,
                        0, 1
                    )
                    local newFOV = math.floor(50 + percent * 450)
                    Settings.FOV = newFOV
                    if FOVCircle then FOVCircle.Radius = newFOV end
                    SliderText.Text = "FOV: " .. newFOV
                    SliderFill.Size = UDim2.new(newFOV / 500, 0, 1, 0)
                    SliderButton.Position = UDim2.new(newFOV / 500, -10, 0.5, -10)
                end
            end)
            
            UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    connection:Disconnect()
                end
            end)
        end)
        
        return SliderFrame
    end
    
    -- Create UI Elements
    createToggle("Aimbot", "Aimbot", 0)
    createToggle("ESP Box", "ESP", 45)
    createToggle("Unlimited Ammo", "UnlimitedAmmo", 90)
    createFOVSlider(135)
    
    -- Draggable UI
    local dragging = false
    local dragStart, startPos
    
    TitleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    TitleBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
            local delta = input.Position - dragStart
            MainFrame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    
    -- Close Button Event
    CloseButton.MouseButton1Click:Connect(function()
        ScreenGui:Destroy()
        if FOVCircle then FOVCircle:Remove() end
        for _, esp in pairs(ESPCache) do
            esp.Box:Remove()
            esp.Name:Remove()
            esp.HealthBar:Remove()
        end
        ESPCache = {}
    end)
    
    return ScreenGui
end

-- ========== INITIALIZE ==========
-- Create FOV Circle
createFOVCircle()

-- Create UI
local UI = createUI()

-- ========== MAIN LOOP ==========
RunService.Heartbeat:Connect(function()
    -- Update FOV Circle Position
    if FOVCircle then
        FOVCircle.Position = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
    end
    
    -- Run Features
    aimAtTarget()
    updateESP()
    updateAmmo()
end)

-- ========== CLEANUP ==========
game:GetService("UserInputService").InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.Insert then
        -- Toggle UI visibility
        local ui = game:GetService("CoreGui"):FindFirstChild("GunfightHackUI")
        if ui then
            ui.Enabled = not ui.Enabled
        end
    end
end)

-- ========== STARTUP MESSAGE ==========
print("==========================================")
print("âœ… GUNFIGHT ARENA HACK LOADED SUCCESSFULLY")
print("==========================================")
print("ðŸŽ¯ AIMBOT: Locks onto closest enemy in FOV")
print("ðŸ‘ï¸ ESP: Shows enemy boxes with health bars")
print("ðŸ”« UNLIMITED AMMO: Never run out of bullets")
print("ðŸŽ® UI: Drag to move, Close button to exit")
print("ðŸ“Œ INSERT: Toggle UI visibility")
print("==========================================")

-- Send notification
task.spawn(function()
    task.wait(1)
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Gunfight Hack Loaded",
        Text = "âœ… All features ready!\nToggle in UI\nPress INSERT to hide/show",
        Duration = 5
    })
end)
