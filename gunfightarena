-- Gunfight Arena Hack - ESP & Aimbot for ENEMIES ONLY
-- Fixed: Kh√¥ng ghim ƒë·ªìng ƒë·ªôi

if not game:IsLoaded() then
    game.Loaded:Wait()
end

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local player = Players.LocalPlayer

repeat task.wait() until player
print("‚úÖ Player loaded")

local camera = Workspace.CurrentCamera

-- Settings
local Settings = {
    Aimbot = false,
    ESP = false,
    UnlimitedAmmo = false,
    FOV = 100,
    TeamCheck = true  -- QUAN TR·ªåNG: Ki·ªÉm tra ƒë·ªôi
}

-- Drawing objects
local circle
local ESPDrawings = {}

-- Ki·ªÉm tra c√≥ ph·∫£i ƒë·ªìng ƒë·ªôi kh√¥ng
local function isEnemy(targetPlayer)
    if not Settings.TeamCheck then 
        return targetPlayer ~= player  -- N·∫øu kh√¥ng ki·ªÉm tra ƒë·ªôi, t·∫•t c·∫£ ƒë·ªÅu l√† enemy tr·ª´ m√¨nh
    end
    
    -- L·∫•y team c·ªßa player hi·ªán t·∫°i
    local myTeam = player.Team or player:GetAttribute("Team") or player:FindFirstChild("Team") 
    local targetTeam = targetPlayer.Team or targetPlayer:GetAttribute("Team") or targetPlayer:FindFirstChild("Team")
    
    -- N·∫øu kh√¥ng c√≥ team system th√¨ coi t·∫•t c·∫£ l√† enemy
    if not myTeam or not targetTeam then
        return targetPlayer ~= player
    end
    
    -- So s√°nh team
    local myTeamName = typeof(myTeam) == "Instance" and myTeam.Name or myTeam
    local targetTeamName = typeof(targetTeam) == "Instance" and targetTeam.Name or targetTeam
    
    return myTeamName ~= targetTeamName
end

-- Create FOV circle
local function createCircle()
    if circle then circle:Remove() end
    
    circle = Drawing.new("Circle")
    circle.Visible = Settings.Aimbot
    circle.Radius = Settings.FOV
    circle.Thickness = 2
    circle.Color = Color3.fromRGB(255, 0, 0)
    circle.Filled = false
    circle.Position = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
end

-- Get closest ENEMY (kh√¥ng ph·∫£i ƒë·ªìng ƒë·ªôi)
local function getClosestEnemy()
    local closest = nil
    local closestDist = Settings.FOV
    local mousePos = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
    
    for _, plr in pairs(Players:GetPlayers()) do
        if plr == player then continue end
        
        -- CH·ªà CH·ªåN ENEMY
        if not isEnemy(plr) then
            continue
        end
        
        local char = plr.Character
        if char and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0 then
            local root = char:FindFirstChild("HumanoidRootPart")
            if root then
                local pos, onScreen = camera:WorldToViewportPoint(root.Position)
                
                if onScreen then
                    local dist = (Vector2.new(pos.X, pos.Y) - mousePos).Magnitude
                    if dist < closestDist then
                        closest = plr
                        closestDist = dist
                    end
                end
            end
        end
    end
    
    return closest
end

-- Aimbot ch·ªâ nh·∫Øm v√†o enemy
local function aimAtEnemy()
    if not Settings.Aimbot then return end
    
    local target = getClosestEnemy()
    if not target or not target.Character then return end
    
    local char = target.Character
    local head = char:FindFirstChild("Head")
    local root = char:FindFirstChild("HumanoidRootPart")
    
    if not head and not root then return end
    
    local aimPart = head or root
    local screenPos = camera:WorldToScreenPoint(aimPart.Position)
    
    if screenPos.Z > 0 then
        local mousePos = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
        local targetPos = Vector2.new(screenPos.X, screenPos.Y)
        local delta = (targetPos - mousePos) * 0.3
        
        mousemoverel(delta.X, delta.Y)
    end
end

-- ESP ch·ªâ hi·ªán enemy
local function updateESP()
    for _, plr in pairs(Players:GetPlayers()) do
        if plr == player then continue end
        
        -- CH·ªà HI·ªÜN ESP CHO ENEMY
        if not isEnemy(plr) then
            if ESPDrawings[plr] then
                ESPDrawings[plr].box.Visible = false
                ESPDrawings[plr].name.Visible = false
                if ESPDrawings[plr].health then
                    ESPDrawings[plr].health.Visible = false
                end
            end
            continue
        end
        
        local char = plr.Character
        local root = char and char:FindFirstChild("HumanoidRootPart")
        local humanoid = char and char:FindFirstChild("Humanoid")
        
        if Settings.ESP and root and humanoid and humanoid.Health > 0 then
            local pos, onScreen = camera:WorldToViewportPoint(root.Position)
            
            if onScreen then
                if not ESPDrawings[plr] then
                    -- Create ESP drawings
                    ESPDrawings[plr] = {
                        box = Drawing.new("Square"),
                        name = Drawing.new("Text"),
                        health = Drawing.new("Text")
                    }
                    
                    local drawings = ESPDrawings[plr]
                    drawings.box.Thickness = 2
                    drawings.box.Color = Color3.fromRGB(255, 50, 50)  -- M√†u ƒë·ªè cho enemy
                    drawings.box.Filled = false
                    
                    drawings.name.Color = Color3.fromRGB(255, 100, 100)
                    drawings.name.Size = 14
                    drawings.name.Font = 2
                    drawings.name.Text = plr.Name .. " [ENEMY]"
                    drawings.name.Outline = true
                    
                    drawings.health.Color = Color3.fromRGB(100, 255, 100)
                    drawings.health.Size = 12
                    drawings.health.Font = 2
                    drawings.health.Outline = true
                end
                
                local drawings = ESPDrawings[plr]
                local head = char:FindFirstChild("Head")
                
                if head then
                    local headPos = camera:WorldToViewportPoint(head.Position)
                    local height = math.abs(headPos.Y - pos.Y) * 2
                    local width = height * 0.6
                    
                    -- Update box
                    drawings.box.Size = Vector2.new(width, height)
                    drawings.box.Position = Vector2.new(pos.X - width/2, pos.Y - height/2)
                    drawings.box.Visible = true
                    
                    -- Update name
                    drawings.name.Position = Vector2.new(pos.X, pos.Y - height/2 - 20)
                    drawings.name.Visible = true
                    
                    -- Update health
                    drawings.health.Text = "HP: " .. math.floor(humanoid.Health) .. "/" .. math.floor(humanoid.MaxHealth)
                    drawings.health.Position = Vector2.new(pos.X, pos.Y + height/2 + 5)
                    drawings.health.Visible = true
                end
            elseif ESPDrawings[plr] then
                ESPDrawings[plr].box.Visible = false
                ESPDrawings[plr].name.Visible = false
                if ESPDrawings[plr].health then
                    ESPDrawings[plr].health.Visible = false
                end
            end
        elseif ESPDrawings[plr] then
            ESPDrawings[plr].box.Visible = false
            ESPDrawings[plr].name.Visible = false
            if ESPDrawings[plr].health then
                ESPDrawings[plr].health.Visible = false
            end
        end
    end
    
    -- Clean up
    for plr, drawings in pairs(ESPDrawings) do
        if not Players:FindFirstChild(plr.Name) then
            drawings.box:Remove()
            drawings.name:Remove()
            if drawings.health then
                drawings.health:Remove()
            end
            ESPDrawings[plr] = nil
        end
    end
end

-- Unlimited ammo
local function updateAmmo()
    if not Settings.UnlimitedAmmo then return end
    
    local char = player.Character
    if not char then return end
    
    -- Find and update ammo in tools
    for _, tool in pairs(char:GetChildren()) do
        if tool:IsA("Tool") then
            -- Check for ammo value
            for _, obj in pairs(tool:GetDescendants()) do
                if obj:IsA("NumberValue") and (obj.Name:lower():find("ammo") or obj.Name:lower():find("bullet")) then
                    obj.Value = 999
                end
            end
        end
    end
end

-- Create UI
local function createUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "HackUI"
    screenGui.Parent = game.CoreGui
    screenGui.ResetOnSpawn = false
    
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 250, 0, 220)
    mainFrame.Position = UDim2.new(0, 10, 0, 10)
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = mainFrame
    
    -- Title
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 30)
    title.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    title.Text = "üî´ ENEMY ONLY HACK"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 16
    title.Parent = mainFrame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 8)
    titleCorner.Parent = title
    
    -- Content
    local content = Instance.new("Frame")
    content.Size = UDim2.new(1, -20, 1, -40)
    content.Position = UDim2.new(0, 10, 0, 40)
    content.BackgroundTransparency = 1
    content.Parent = mainFrame
    
    -- Create toggle buttons
    local yPos = 0
    
    local function addToggle(text, setting)
        local button = Instance.new("TextButton")
        button.Size = UDim2.new(1, 0, 0, 35)
        button.Position = UDim2.new(0, 0, 0, yPos)
        button.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
        button.Text = ""
        button.Parent = content
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 6)
        corner.Parent = button
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0.7, 0, 1, 0)
        label.Position = UDim2.new(0, 10, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = "  " .. text
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.Font = Enum.Font.Gotham
        label.TextSize = 14
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = button
        
        local indicator = Instance.new("Frame")
        indicator.Size = UDim2.new(0, 40, 0, 20)
        indicator.Position = UDim2.new(1, -45, 0.5, -10)
        indicator.AnchorPoint = Vector2.new(1, 0.5)
        indicator.BackgroundColor3 = Settings[setting] and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(80, 80, 80)
        indicator.Parent = button
        
        local indCorner = Instance.new("UICorner")
        indCorner.CornerRadius = UDim.new(0, 10)
        indCorner.Parent = indicator
        
        button.MouseButton1Click:Connect(function()
            Settings[setting] = not Settings[setting]
            indicator.BackgroundColor3 = Settings[setting] and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(80, 80, 80)
            
            if setting == "Aimbot" then
                if circle then
                    circle.Visible = Settings.Aimbot
                else
                    createCircle()
                end
            end
            
            print(text .. ": " .. (Settings[setting] and "ON" or "OFF"))
        end)
        
        yPos = yPos + 40
    end
    
    -- FOV slider
    local function addFOVSlider()
        local sliderFrame = Instance.new("Frame")
        sliderFrame.Size = UDim2.new(1, 0, 0, 50)
        sliderFrame.Position = UDim2.new(0, 0, 0, yPos)
        sliderFrame.BackgroundTransparency = 1
        sliderFrame.Parent = content
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, 0, 0, 20)
        label.BackgroundTransparency = 1
        label.Text = "FOV: " .. Settings.FOV
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.Font = Enum.Font.Gotham
        label.TextSize = 14
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = sliderFrame
        
        local slider = Instance.new("Frame")
        slider.Size = UDim2.new(1, 0, 0, 6)
        slider.Position = UDim2.new(0, 0, 0, 25)
        slider.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
        slider.Parent = sliderFrame
        
        local fill = Instance.new("Frame")
        fill.Size = UDim2.new(Settings.FOV / 500, 0, 1, 0)
        fill.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        fill.Parent = slider
        
        local button = Instance.new("TextButton")
        button.Size = UDim2.new(0, 20, 0, 20)
        button.Position = UDim2.new(Settings.FOV / 500, -10, 0.5, -10)
        button.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        button.Text = ""
        button.Parent = slider
        
        button.MouseButton1Down:Connect(function()
            local connection
            connection = UserInputService.InputChanged:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseMovement then
                    local percent = math.clamp((input.Position.X - slider.AbsolutePosition.X) / slider.AbsoluteSize.X, 0, 1)
                    local newFOV = math.floor(50 + percent * 450)
                    Settings.FOV = newFOV
                    if circle then circle.Radius = newFOV end
                    label.Text = "FOV: " .. newFOV
                    fill.Size = UDim2.new(newFOV / 500, 0, 1, 0)
                    button.Position = UDim2.new(newFOV / 500, -10, 0.5, -10)
                end
            end)
            
            UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    connection:Disconnect()
                end
            end)
        end)
        
        yPos = yPos + 60
    end
    
    addToggle("Aimbot (Enemy Only)", "Aimbot")
    addToggle("ESP (Enemy Only)", "ESP")
    addToggle("Unlimited Ammo", "UnlimitedAmmo")
    addFOVSlider()
    
    -- Close button
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 25, 0, 25)
    closeBtn.Position = UDim2.new(1, -30, 0, 5)
    closeBtn.AnchorPoint = Vector2.new(1, 0)
    closeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    closeBtn.Text = "X"
    closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 14
    closeBtn.Parent = title
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 6)
    closeCorner.Parent = closeBtn
    
    closeBtn.MouseButton1Click:Connect(function()
        screenGui:Destroy()
        if circle then circle:Remove() end
        for _, drawings in pairs(ESPDrawings) do
            drawings.box:Remove()
            drawings.name:Remove()
            if drawings.health then
                drawings.health:Remove()
            end
        end
    end)
    
    -- Draggable
    local dragging = false
    local dragStart, startPos
    
    title.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    title.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
            local delta = input.Position - dragStart
            mainFrame.Position = UDim2.new(
                startPos.X.Scale, 
                startPos.X.Offset + delta.X,
                startPos.Y.Scale, 
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    
    return screenGui
end

-- Initialize
createCircle()
local ui = createUI()

-- Main loop
RunService.Heartbeat:Connect(function()
    -- Update circle position
    if circle then
        circle.Position = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
    end
    
    -- Run features
    aimAtEnemy()
    updateESP()
    updateAmmo()
end)

-- Display enemy count
RunService.Heartbeat:Connect(function()
    local enemyCount = 0
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= player and isEnemy(plr) then
            enemyCount = enemyCount + 1
        end
    end
    
    -- Update UI title
    if ui and ui:FindFirstChild("HackUI") then
        local title = ui.HackUI:FindFirstChild("Frame"):FindFirstChild("TextLabel")
        if title then
            title.Text = "üî´ ENEMIES: " .. enemyCount
        end
    end
end)

-- Notification
task.spawn(function()
    wait(1)
    game.StarterGui:SetCore("SendNotification", {
        Title = "Enemy-Only Hack",
        Text = "‚úÖ Aimbot & ESP ch·ªâ ho·∫°t ƒë·ªông v·ªõi ENEMY\n‚úÖ ƒê·ªìng ƒë·ªôi s·∫Ω kh√¥ng b·ªã ·∫£nh h∆∞·ªüng",
        Duration = 5
    })
end)

print("==========================================")
print("‚úÖ ENEMY-ONLY HACK LOADED")
print("üéØ Aimbot: Ch·ªâ nh·∫Øm v√†o ENEMY")
print("üëÅÔ∏è ESP: Ch·ªâ hi·ªán ENEMY")
print("üî´ Ammo: Unlimited")
print("==========================================")
