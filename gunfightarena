-- Gunfight Arena Hack - Fixed Version
-- No infinite yield errors

-- Simple wait for game
if not game:IsLoaded() then
    game.Loaded:Wait()
end

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local player = Players.LocalPlayer

-- Wait for player
repeat task.wait() until player
print("âœ… Player loaded")

local camera = Workspace.CurrentCamera

-- Settings
local Settings = {
    Aimbot = false,
    ESP = false,
    UnlimitedAmmo = false,
    FOV = 100
}

-- Drawing objects
local circle
local ESPDrawings = {}

-- Create FOV circle
local function createCircle()
    if circle then circle:Remove() end
    
    circle = Drawing.new("Circle")
    circle.Visible = Settings.Aimbot
    circle.Radius = Settings.FOV
    circle.Thickness = 2
    circle.Color = Color3.fromRGB(255, 0, 0)
    circle.Filled = false
    circle.Position = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
end

-- Get closest player
local function getClosestPlayer()
    local closest = nil
    local closestDist = Settings.FOV
    local mousePos = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
    
    for _, plr in pairs(Players:GetPlayers()) do
        if plr == player then continue end
        
        local char = plr.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            local root = char.HumanoidRootPart
            local pos, onScreen = camera:WorldToViewportPoint(root.Position)
            
            if onScreen then
                local dist = (Vector2.new(pos.X, pos.Y) - mousePos).Magnitude
                if dist < closestDist then
                    closest = plr
                    closestDist = dist
                end
            end
        end
    end
    
    return closest
end

-- Aimbot function
local function aimAtTarget()
    if not Settings.Aimbot then return end
    
    local target = getClosestPlayer()
    if not target or not target.Character then return end
    
    local root = target.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end
    
    local screenPos = camera:WorldToScreenPoint(root.Position)
    if screenPos.Z > 0 then
        local mousePos = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
        local targetPos = Vector2.new(screenPos.X, screenPos.Y)
        local delta = (targetPos - mousePos) * 0.3
        
        mousemoverel(delta.X, delta.Y)
    end
end

-- ESP function
local function updateESP()
    for _, plr in pairs(Players:GetPlayers()) do
        if plr == player then continue end
        
        local char = plr.Character
        local root = char and char:FindFirstChild("HumanoidRootPart")
        
        if Settings.ESP and root then
            local pos, onScreen = camera:WorldToViewportPoint(root.Position)
            
            if onScreen then
                if not ESPDrawings[plr] then
                    -- Create ESP drawings
                    ESPDrawings[plr] = {
                        box = Drawing.new("Square"),
                        name = Drawing.new("Text")
                    }
                    
                    local drawings = ESPDrawings[plr]
                    drawings.box.Thickness = 2
                    drawings.box.Color = Color3.fromRGB(0, 255, 0)
                    drawings.box.Filled = false
                    
                    drawings.name.Color = Color3.fromRGB(255, 255, 255)
                    drawings.name.Size = 14
                    drawings.name.Font = 2
                    drawings.name.Text = plr.Name
                    drawings.name.Outline = true
                end
                
                local drawings = ESPDrawings[plr]
                local head = char:FindFirstChild("Head")
                
                if head then
                    local headPos = camera:WorldToViewportPoint(head.Position)
                    local height = math.abs(headPos.Y - pos.Y) * 2
                    local width = height * 0.6
                    
                    drawings.box.Size = Vector2.new(width, height)
                    drawings.box.Position = Vector2.new(pos.X - width/2, pos.Y - height/2)
                    drawings.box.Visible = true
                    
                    drawings.name.Position = Vector2.new(pos.X, pos.Y - height/2 - 20)
                    drawings.name.Visible = true
                end
            elseif ESPDrawings[plr] then
                ESPDrawings[plr].box.Visible = false
                ESPDrawings[plr].name.Visible = false
            end
        elseif ESPDrawings[plr] then
            ESPDrawings[plr].box.Visible = false
            ESPDrawings[plr].name.Visible = false
        end
    end
    
    -- Clean up
    for plr, drawings in pairs(ESPDrawings) do
        if not Players:FindFirstChild(plr.Name) then
            drawings.box:Remove()
            drawings.name:Remove()
            ESPDrawings[plr] = nil
        end
    end
end

-- Unlimited ammo (simpler method)
local function updateAmmo()
    if not Settings.UnlimitedAmmo then return end
    
    local char = player.Character
    if not char then return end
    
    -- Try to find gun
    for _, tool in pairs(char:GetChildren()) do
        if tool:IsA("Tool") then
            local ammo = tool:FindFirstChild("Ammo")
            if ammo and ammo:IsA("NumberValue") then
                ammo.Value = 999
            end
        end
    end
end

-- Create simple UI
local function createUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "HackUI"
    screenGui.Parent = game.CoreGui
    screenGui.ResetOnSpawn = false
    
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 250, 0, 200)
    mainFrame.Position = UDim2.new(0, 10, 0, 10)
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = mainFrame
    
    -- Title
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 30)
    title.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    title.Text = "ðŸ”« GUNFIGHT HACK"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 16
    title.Parent = mainFrame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 8)
    titleCorner.Parent = title
    
    -- Content
    local content = Instance.new("Frame")
    content.Size = UDim2.new(1, -20, 1, -40)
    content.Position = UDim2.new(0, 10, 0, 40)
    content.BackgroundTransparency = 1
    content.Parent = mainFrame
    
    -- Create toggle buttons
    local yPos = 0
    local buttons = {}
    
    local function addToggle(text, setting)
        local button = Instance.new("TextButton")
        button.Size = UDim2.new(1, 0, 0, 35)
        button.Position = UDim2.new(0, 0, 0, yPos)
        button.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
        button.Text = ""
        button.Parent = content
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 6)
        corner.Parent = button
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0.7, 0, 1, 0)
        label.Position = UDim2.new(0, 10, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = "  " .. text
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.Font = Enum.Font.Gotham
        label.TextSize = 14
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = button
        
        local indicator = Instance.new("Frame")
        indicator.Size = UDim2.new(0, 40, 0, 20)
        indicator.Position = UDim2.new(1, -45, 0.5, -10)
        indicator.AnchorPoint = Vector2.new(1, 0.5)
        indicator.BackgroundColor3 = Settings[setting] and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(80, 80, 80)
        indicator.Parent = button
        
        local indCorner = Instance.new("UICorner")
        indCorner.CornerRadius = UDim.new(0, 10)
        indCorner.Parent = indicator
        
        button.MouseButton1Click:Connect(function()
            Settings[setting] = not Settings[setting]
            indicator.BackgroundColor3 = Settings[setting] and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(80, 80, 80)
            
            if setting == "Aimbot" then
                if circle then
                    circle.Visible = Settings.Aimbot
                else
                    createCircle()
                end
            end
            
            print(text .. ": " .. (Settings[setting] and "ON" or "OFF"))
        end)
        
        yPos = yPos + 40
        buttons[setting] = button
    end
    
    addToggle("Aimbot", "Aimbot")
    addToggle("ESP Box", "ESP")
    addToggle("Unlimited Ammo", "UnlimitedAmmo")
    
    -- Close button
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 25, 0, 25)
    closeBtn.Position = UDim2.new(1, -30, 0, 5)
    closeBtn.AnchorPoint = Vector2.new(1, 0)
    closeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    closeBtn.Text = "X"
    closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 14
    closeBtn.Parent = title
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 6)
    closeCorner.Parent = closeBtn
    
    closeBtn.MouseButton1Click:Connect(function()
        screenGui:Destroy()
        if circle then circle:Remove() end
        for _, drawings in pairs(ESPDrawings) do
            drawings.box:Remove()
            drawings.name:Remove()
        end
    end)
    
    -- Draggable
    local dragging = false
    local dragStart, startPos
    
    title.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    title.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
            local delta = input.Position - dragStart
            mainFrame.Position = UDim2.new(
                startPos.X.Scale, 
                startPos.X.Offset + delta.X,
                startPos.Y.Scale, 
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    
    return screenGui
end

-- Initialize
createCircle()
local ui = createUI()

-- Main loop
RunService.Heartbeat:Connect(function()
    -- Update circle position
    if circle then
        circle.Position = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
    end
    
    -- Run features
    aimAtTarget()
    updateESP()
    updateAmmo()
end)

-- Notification
task.spawn(function()
    wait(1)
    game.StarterGui:SetCore("SendNotification", {
        Title = "Gunfight Hack",
        Text = "âœ… Hack loaded successfully!\nOpen UI to toggle features",
        Duration = 5
    })
end)

print("=================================")
print("âœ… GUNFIGHT ARENA HACK LOADED")
print("ðŸ“Œ Features: Aimbot, ESP, Unlimited Ammo")
print("=================================")
